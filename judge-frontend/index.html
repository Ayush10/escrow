<!DOCTYPE html>
<html><head>
<meta charset="utf-8">
<title>Agent Court</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

:root {
  --bg: #0a0a0f;
  --bg2: #12121a;
  --bg3: #1a1a28;
  --border: #1e1e30;
  --accent: #e94560;
  --accent2: #c73652;
  --green: #00d4aa;
  --green-dim: #0a3d30;
  --yellow: #f0c040;
  --blue: #58a6ff;
  --purple: #bc8cff;
  --orange: #ffa657;
  --red: #e94560;
  --text: #e0e0e8;
  --text2: #8b8ba0;
  --text3: #55556a;
}

* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

/* HEADER */
.header {
  padding: 0 32px;
  height: 64px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
  background: var(--bg2);
}
.header-left { display: flex; align-items: center; gap: 16px; }
.logo { display: flex; align-items: center; gap: 10px; }
.logo-icon { width: 32px; height: 32px; background: var(--accent); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 700; color: white; }
.logo-text { font-size: 18px; font-weight: 700; color: var(--text); }
.logo-text span { color: var(--accent); }
.chain-badge { padding: 4px 10px; background: var(--bg3); border: 1px solid var(--border); border-radius: 12px; font-size: 11px; color: var(--text2); font-family: 'JetBrains Mono', monospace; }
.header-right { display: flex; align-items: center; gap: 12px; }
.status-dot { width: 8px; height: 8px; border-radius: 50%; }
.status-dot.on { background: var(--green); box-shadow: 0 0 8px var(--green); }
.status-dot.off { background: var(--red); }
.status-text { font-size: 12px; color: var(--text2); font-family: 'JetBrains Mono', monospace; }

/* NAV */
.nav { display: flex; gap: 0; border-bottom: 1px solid var(--border); background: var(--bg2); padding: 0 32px; }
.nav-tab {
  padding: 12px 20px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 500;
  color: var(--text2);
  border-bottom: 2px solid transparent;
  transition: all 0.15s;
}
.nav-tab:hover { color: var(--text); }
.nav-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

/* LAYOUT */
.main { max-width: 1100px; margin: 0 auto; padding: 24px 32px; }
.panel { display: none; }
.panel.active { display: block; }

/* STATS ROW */
.stats-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 28px; }
.stat-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 16px;
  text-align: center;
}
.stat-val { font-size: 28px; font-weight: 700; color: var(--text); font-family: 'JetBrains Mono', monospace; }
.stat-val.green { color: var(--green); }
.stat-val.yellow { color: var(--yellow); }
.stat-val.red { color: var(--accent); }
.stat-label { font-size: 11px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }

/* SECTION */
.section { margin-bottom: 28px; }
.section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.section-title { font-size: 13px; font-weight: 600; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; }
.section-badge { padding: 2px 8px; background: var(--bg3); border-radius: 8px; font-size: 11px; color: var(--text3); }

/* DISPUTE CARD */
.dispute-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 10px;
  margin-bottom: 12px;
  overflow: hidden;
  transition: border-color 0.15s;
}
.dispute-card:hover { border-color: #2a2a40; }
.dispute-card.open { border-left: 3px solid var(--yellow); }
.dispute-card.resolved { border-left: 3px solid var(--green); }

.dispute-top {
  padding: 16px 20px;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  cursor: pointer;
}
.dispute-meta { flex: 1; }
.dispute-id { font-size: 12px; color: var(--text3); font-family: 'JetBrains Mono', monospace; margin-bottom: 6px; }
.dispute-parties { display: flex; gap: 24px; font-size: 13px; }
.party-label { color: var(--text3); font-size: 11px; text-transform: uppercase; }
.party-addr { color: var(--blue); font-family: 'JetBrains Mono', monospace; font-size: 12px; }
.dispute-right { text-align: right; }
.dispute-stake { font-family: 'JetBrains Mono', monospace; font-size: 14px; color: var(--yellow); }
.dispute-tier {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  margin-top: 4px;
}
.tier-district { background: #1a2a1a; color: var(--green); }
.tier-appeals { background: #2a2a1a; color: var(--yellow); }
.tier-supreme { background: #2a1a2a; color: var(--purple); }
.dispute-status {
  padding: 3px 10px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
}
.status-open { background: #3d3a0a; color: var(--yellow); }
.status-resolved { background: var(--green-dim); color: var(--green); }

/* RULING / OPINION */
.dispute-detail { display: none; border-top: 1px solid var(--border); }
.dispute-detail.show { display: block; }

.ruling-banner {
  padding: 12px 20px;
  display: flex;
  align-items: center;
  gap: 12px;
}
.ruling-banner.plaintiff { background: linear-gradient(90deg, #0a3d30 0%, transparent 100%); }
.ruling-banner.defendant { background: linear-gradient(90deg, #3d0a20 0%, transparent 100%); }
.ruling-verdict { font-size: 14px; font-weight: 700; }
.ruling-verdict.plaintiff { color: var(--green); }
.ruling-verdict.defendant { color: var(--red); }

.opinion-container {
  padding: 20px;
  background: var(--bg);
  border-top: 1px solid var(--border);
}
.opinion-toggle {
  font-size: 12px;
  color: var(--accent);
  cursor: pointer;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.opinion-toggle:hover { text-decoration: underline; }
.opinion-text {
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  line-height: 1.7;
  color: var(--text2);
  white-space: pre-wrap;
  max-height: 500px;
  overflow-y: auto;
  padding: 16px;
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 6px;
}
.opinion-text h1, .opinion-text h2, .opinion-text h3 { color: var(--text); margin: 12px 0 6px 0; }
.opinion-text strong { color: var(--text); }

/* AGENTS TAB */
.agent-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 12px;
}
.agent-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.agent-addr { font-family: 'JetBrains Mono', monospace; font-size: 14px; color: var(--blue); }
.agent-role { padding: 3px 10px; border-radius: 4px; font-size: 11px; font-weight: 600; }
.role-judge { background: #2a1a2a; color: var(--purple); }
.role-agent { background: #1a2a3a; color: var(--blue); }
.agent-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
.agent-stat { text-align: center; }
.agent-stat-val { font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 600; }
.agent-stat-label { font-size: 11px; color: var(--text3); margin-top: 2px; }

/* COURT TIERS */
.tiers { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 28px; }
.tier-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 20px;
  text-align: center;
  position: relative;
  overflow: hidden;
}
.tier-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
}
.tier-card.district::before { background: var(--green); }
.tier-card.appeals::before { background: var(--yellow); }
.tier-card.supreme::before { background: var(--purple); }
.tier-name { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
.tier-model { font-size: 12px; color: var(--text3); font-family: 'JetBrains Mono', monospace; margin-bottom: 8px; }
.tier-fee { font-size: 24px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
.tier-fee.green { color: var(--green); }
.tier-fee.yellow { color: var(--yellow); }
.tier-fee.purple { color: var(--purple); }

/* SERVICES TAB */
.service-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 16px 20px;
  margin-bottom: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.service-info { flex: 1; }
.service-id { font-size: 12px; color: var(--text3); font-family: 'JetBrains Mono', monospace; }
.service-provider { font-size: 12px; color: var(--blue); font-family: 'JetBrains Mono', monospace; margin-top: 4px; }
.service-price { font-family: 'JetBrains Mono', monospace; font-size: 16px; color: var(--yellow); }
.service-stats-row { display: flex; gap: 16px; font-size: 12px; color: var(--text3); }

/* LOADING */
.loading { text-align: center; padding: 40px; color: var(--text3); }
.loading-spinner {
  width: 24px; height: 24px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: 0 auto 12px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* FOOTER */
.footer {
  text-align: center;
  padding: 24px;
  font-size: 11px;
  color: var(--text3);
  border-top: 1px solid var(--border);
  margin-top: 40px;
}
.footer a { color: var(--accent); text-decoration: none; }
.footer a:hover { text-decoration: underline; }

/* RESPONSIVE */
@media (max-width: 768px) {
  .stats-row { grid-template-columns: repeat(2, 1fr); }
  .tiers { grid-template-columns: 1fr; }
  .agent-stats { grid-template-columns: repeat(2, 1fr); }
  .main { padding: 16px; }
}
</style>
</head><body>

<div class="header">
  <div class="header-left">
    <div class="logo">
      <div class="logo-icon">AC</div>
      <div class="logo-text">Agent <span>Court</span></div>
    </div>
    <div class="chain-badge" id="chainBadge">GOAT Testnet3 (48816)</div>
  </div>
  <div class="header-right">
    <div class="status-dot off" id="statusDot"></div>
    <span class="status-text" id="statusText">Connecting...</span>
  </div>
</div>

<div class="nav">
  <div class="nav-tab active" onclick="switchTab('overview')">Overview</div>
  <div class="nav-tab" onclick="switchTab('disputes')">Disputes</div>
  <div class="nav-tab" onclick="switchTab('agents')">Agents</div>
  <div class="nav-tab" onclick="switchTab('services')">Services</div>
</div>

<div class="main">
  <!-- OVERVIEW -->
  <div class="panel active" id="panel-overview">
    <div class="stats-row" id="statsRow">
      <div class="stat-card"><div class="stat-val" id="statDisputes">-</div><div class="stat-label">Disputes</div></div>
      <div class="stat-card"><div class="stat-val green" id="statResolved">-</div><div class="stat-label">Resolved</div></div>
      <div class="stat-card"><div class="stat-val yellow" id="statServices">-</div><div class="stat-label">Services</div></div>
      <div class="stat-card"><div class="stat-val" id="statTransactions">-</div><div class="stat-label">Transactions</div></div>
      <div class="stat-card"><div class="stat-val green" id="statContractBal">-</div><div class="stat-label">USDC in Escrow</div></div>
    </div>

    <div class="section">
      <div class="section-header">
        <span class="section-title">Court System</span>
      </div>
      <div class="tiers">
        <div class="tier-card district">
          <div class="tier-name">District Court</div>
          <div class="tier-model">claude-haiku-4-5</div>
          <div class="tier-fee green" id="feeDistrict">$0.05</div>
          <div class="stat-label" style="margin-top:8px">First hearing</div>
        </div>
        <div class="tier-card appeals">
          <div class="tier-name">Appeals Court</div>
          <div class="tier-model">claude-sonnet-4-6</div>
          <div class="tier-fee yellow" id="feeAppeals">$0.10</div>
          <div class="stat-label" style="margin-top:8px">1 prior loss</div>
        </div>
        <div class="tier-card supreme">
          <div class="tier-name">Supreme Court</div>
          <div class="tier-model">claude-opus-4-6</div>
          <div class="tier-fee purple" id="feeSupreme">$0.20</div>
          <div class="stat-label" style="margin-top:8px">Final ruling</div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">
        <span class="section-title">Recent Disputes</span>
      </div>
      <div id="recentDisputes"><div class="loading"><div class="loading-spinner"></div>Loading from chain...</div></div>
    </div>
  </div>

  <!-- DISPUTES -->
  <div class="panel" id="panel-disputes">
    <div class="section">
      <div class="section-header">
        <span class="section-title">All Disputes</span>
        <span class="section-badge" id="disputeCountBadge">0</span>
      </div>
      <div id="allDisputes"><div class="loading"><div class="loading-spinner"></div>Loading...</div></div>
    </div>
  </div>

  <!-- AGENTS -->
  <div class="panel" id="panel-agents">
    <div class="section">
      <div class="section-header">
        <span class="section-title">Registered Agents</span>
      </div>
      <div id="agentsList"><div class="loading"><div class="loading-spinner"></div>Loading...</div></div>
    </div>
  </div>

  <!-- SERVICES -->
  <div class="panel" id="panel-services">
    <div class="section">
      <div class="section-header">
        <span class="section-title">Registered Services</span>
        <span class="section-badge" id="serviceCountBadge">0</span>
      </div>
      <div id="servicesList"><div class="loading"><div class="loading-spinner"></div>Loading...</div></div>
    </div>
  </div>
</div>

<div class="footer">
  Agent Court on <a href="https://explorer.testnet3.goat.network/address/CONTRACT_ADDR" id="explorerLink" target="_blank">GOAT Testnet3</a>
  &nbsp;|&nbsp; <a href="https://github.com/Ayush10/escrow" target="_blank">GitHub</a>
  &nbsp;|&nbsp; ERC-8004 Identity Enforced
</div>

<script>
// --- CONFIG ---
const RPC = 'https://rpc.testnet3.goat.network';
const CONTRACT = '0xFBf9b5293A1737AC53880d3160a64B49bA54801D';
const USDC_ADDR = '0x29d1ee93e9ecf6e50f309f498e40a6b42d352fa1';
const VERDICT_API = '/api'; // real verdict API proxied through nginx
const EXPLORER = 'https://explorer.testnet3.goat.network';

const COURT_TIERS = ['district', 'appeals', 'supreme'];
const TIER_MODELS = ['claude-haiku-4-5', 'claude-sonnet-4-6', 'claude-opus-4-6'];
const TIER_CLASSES = ['tier-district', 'tier-appeals', 'tier-supreme'];

// Minimal ABI — read-only functions we need
const ABI = [
  "function disputeCount() view returns (uint256)",
  "function serviceCount() view returns (uint256)",
  "function transactionCount() view returns (uint256)",
  "function judge() view returns (address)",
  "function minDeposit() view returns (uint256)",
  "function judgeFees(uint256) view returns (uint256)",
  "function paymentToken() view returns (address)",
  "function requireIdentity() view returns (bool)",
  "function getDispute(uint256 disputeId) view returns (tuple(uint256 transactionId, address plaintiff, address defendant, uint256 stake, uint256 judgeFee, uint8 tier, bytes32 plaintiffEvidence, bytes32 defendantEvidence, bool resolved, address winner))",
  "function getService(uint256 serviceId) view returns (tuple(address provider, bytes32 termsHash, uint256 price, uint256 bondRequired, uint8 status, uint256 totalCalls, uint256 totalDisputes))",
  "function getTransaction(uint256 txId) view returns (tuple(uint256 serviceId, address consumer, address provider, uint256 payment, bytes32 requestHash, bytes32 responseHash, uint8 status, uint64 createdAt, uint64 fulfilledAt, uint256 disputeId))",
  "function getBalance(address agent) view returns (uint256)",
  "function getStats(address agent) view returns (tuple(uint256 totalTransactions, uint256 successfulTransactions, uint256 disputesWon, uint256 disputesLost, uint256 totalEarned, uint256 totalSpent, uint64 registeredAt))",
  "function getSuccessRate(address agent) view returns (uint256)",
  "function balances(address) view returns (uint256)",
  "function disputeLossCount(address) view returns (uint8)",
  "function isRegistered(address agent) view returns (bool)",
];

const USDC_ABI = [
  "function balanceOf(address) view returns (uint256)",
];

let provider, contract, usdcContract;
let disputes = [];
let knownAgents = new Set();

// --- INIT ---
async function init() {
  try {
    provider = new ethers.JsonRpcProvider(RPC);
    contract = new ethers.Contract(CONTRACT, ABI, provider);
    usdcContract = new ethers.Contract(USDC_ADDR, USDC_ABI, provider);

    document.getElementById('statusDot').className = 'status-dot on';
    document.getElementById('statusText').textContent = shortAddr(CONTRACT);
    document.getElementById('explorerLink').href = `${EXPLORER}/address/${CONTRACT}`;

    await Promise.all([loadStats(), loadDisputes(), loadServices()]);
  } catch (e) {
    document.getElementById('statusText').textContent = 'Connection failed';
    console.error(e);
  }
}

// --- HELPERS ---
function shortAddr(a) { return a.slice(0, 6) + '...' + a.slice(-4); }
function formatUSDC(wei) { return (Number(wei) / 1e6).toFixed(wei > 0 ? 4 : 2); }
function tierName(t) { return COURT_TIERS[t] || 'district'; }
function tierClass(t) { return TIER_CLASSES[t] || TIER_CLASSES[0]; }
function zeroHash(h) { return !h || h === '0x' + '0'.repeat(64); }

// --- LOAD DATA ---
async function loadStats() {
  const [dCount, sCount, tCount] = await Promise.all([
    contract.disputeCount(),
    contract.serviceCount(),
    contract.transactionCount(),
  ]);
  document.getElementById('statDisputes').textContent = Number(dCount);
  document.getElementById('statServices').textContent = Number(sCount);
  document.getElementById('statTransactions').textContent = Number(tCount);

  // USDC balance of contract
  try {
    const bal = await usdcContract.balanceOf(CONTRACT);
    document.getElementById('statContractBal').textContent = '$' + formatUSDC(bal);
  } catch(e) {
    document.getElementById('statContractBal').textContent = '-';
  }

  // Judge fees
  try {
    const [f0, f1, f2] = await Promise.all([
      contract.judgeFees(0), contract.judgeFees(1), contract.judgeFees(2),
    ]);
    document.getElementById('feeDistrict').textContent = '$' + formatUSDC(f0);
    document.getElementById('feeAppeals').textContent = '$' + formatUSDC(f1);
    document.getElementById('feeSupreme').textContent = '$' + formatUSDC(f2);
  } catch(e) {}
}

async function loadDisputes() {
  const count = Number(await contract.disputeCount());
  document.getElementById('disputeCountBadge').textContent = count;

  disputes = [];
  let resolvedCount = 0;
  const fetches = [];
  for (let i = 0; i < count; i++) {
    fetches.push(contract.getDispute(i).then(d => {
      disputes[i] = d;
      knownAgents.add(d.plaintiff);
      knownAgents.add(d.defendant);
      if (d.winner && d.winner !== ethers.ZeroAddress) knownAgents.add(d.winner);
      if (d.resolved) resolvedCount++;
    }));
  }
  await Promise.all(fetches);

  document.getElementById('statResolved').textContent = resolvedCount;

  // Render recent (overview)
  const recent = disputes.slice(-5).reverse();
  document.getElementById('recentDisputes').innerHTML = recent.length
    ? recent.map((d, j) => renderDispute(count - 1 - j, d)).join('')
    : '<div style="color:var(--text3);padding:20px;text-align:center">No disputes filed yet</div>';

  // Render all (disputes tab)
  const all = [...disputes].reverse();
  document.getElementById('allDisputes').innerHTML = all.length
    ? all.map((d, j) => renderDispute(count - 1 - j, d)).join('')
    : '<div style="color:var(--text3);padding:20px;text-align:center">No disputes filed yet</div>';

  // Load agents
  await loadAgents();
}

function renderDispute(id, d) {
  const resolved = d.resolved;
  const winner = resolved ? (d.winner === d.plaintiff ? 'plaintiff' : 'defendant') : null;
  const tier = Number(d.tier);
  const hasOpinion = !zeroHash(d.plaintiffEvidence) || !zeroHash(d.defendantEvidence);

  return `
  <div class="dispute-card ${resolved ? 'resolved' : 'open'}" id="dispute-${id}">
    <div class="dispute-top" onclick="toggleDispute(${id})">
      <div class="dispute-meta">
        <div class="dispute-id">DISPUTE #${id} &nbsp; TX #${Number(d.transactionId)}</div>
        <div class="dispute-parties">
          <div>
            <div class="party-label">Plaintiff</div>
            <div class="party-addr">${shortAddr(d.plaintiff)}</div>
          </div>
          <div style="color:var(--text3);font-size:20px;align-self:center">vs</div>
          <div>
            <div class="party-label">Defendant</div>
            <div class="party-addr">${shortAddr(d.defendant)}</div>
          </div>
        </div>
      </div>
      <div class="dispute-right">
        <div class="dispute-stake">${formatUSDC(d.stake)} USDC</div>
        <div class="dispute-tier ${tierClass(tier)}">${tierName(tier)}</div>
        <div style="margin-top:6px">
          ${resolved
            ? `<span class="dispute-status status-resolved">RESOLVED</span>`
            : `<span class="dispute-status status-open">OPEN</span>`
          }
        </div>
      </div>
    </div>
    ${resolved ? `
    <div class="ruling-banner ${winner}">
      <span class="ruling-verdict ${winner}">
        ${winner === 'plaintiff' ? 'PLAINTIFF WINS' : 'DEFENDANT WINS'}
      </span>
      <span style="color:var(--text3);font-size:12px">
        &mdash; ${tierName(tier)} court &mdash; Winner: ${shortAddr(d.winner)}
      </span>
    </div>` : ''}
    <div class="dispute-detail" id="detail-${id}">
      <div class="opinion-container">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;font-size:12px;font-family:'JetBrains Mono',monospace;">
          <div>
            <span style="color:var(--text3)">Plaintiff Evidence:</span><br>
            <span style="color:var(--text2);word-break:break-all">${d.plaintiffEvidence}</span>
          </div>
          <div>
            <span style="color:var(--text3)">Defendant Evidence:</span><br>
            <span style="color:var(--text2);word-break:break-all">${d.defendantEvidence}</span>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:12px;font-family:'JetBrains Mono',monospace;">
          <div>
            <span style="color:var(--text3)">Stake:</span>
            <span style="color:var(--yellow)">${formatUSDC(d.stake)} USDC</span>
          </div>
          <div>
            <span style="color:var(--text3)">Judge Fee:</span>
            <span style="color:var(--yellow)">${formatUSDC(d.judgeFee)} USDC</span>
          </div>
        </div>
        <div id="opinion-${id}" style="margin-top:16px"></div>
      </div>
    </div>
  </div>`;
}

function toggleDispute(id) {
  const el = document.getElementById('detail-' + id);
  el.classList.toggle('show');
  if (el.classList.contains('show')) {
    loadOpinion(id);
  }
}

async function loadOpinion(id) {
  const el = document.getElementById('opinion-' + id);
  if (el.dataset.loaded) return;

  el.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Loading judicial opinion...</div>';

  // Fetch from verdict API
  try {
    const resp = await fetch(`${VERDICT_API}/verdicts/${id}`);
    if (resp.ok) {
      const data = await resp.json();
      const opinion = data.opinion || '';
      if (opinion) {
        const d = disputes[id];
        el.innerHTML = renderOpinion(tierName(Number(d?.tier || data.tier || 0)), opinion);
        el.dataset.loaded = '1';
        return;
      }
    }
  } catch(e) {}

  // No opinion in API — show on-chain result
  const d = disputes[id];
  if (d && d.resolved) {
    const winner = d.winner === d.plaintiff ? 'PLAINTIFF' : 'DEFENDANT';
    el.innerHTML = `
      <div style="padding:4px 0;color:var(--text2);font-size:13px">
        <strong style="color:var(--text)">${winner} wins</strong> — Ruling submitted on-chain.
        <br><span style="color:var(--text3);font-size:12px">Opinion not yet published to the verdict API.</span>
      </div>`;
  } else {
    el.innerHTML = '<div style="color:var(--yellow);font-size:13px">Awaiting ruling — dispute is open.</div>';
  }
  el.dataset.loaded = '1';
}

function renderOpinion(court, text) {
  // Convert markdown-ish headers to styled HTML
  let html = escapeHtml(text);
  html = html.replace(/^(#{1,3})\s+(.+)$/gm, (m, hashes, title) => {
    const level = hashes.length;
    const sizes = {'1': '16px', '2': '14px', '3': '13px'};
    return `<div style="color:var(--text);font-weight:700;font-size:${sizes[level]};margin:16px 0 6px 0">${title}</div>`;
  });
  html = html.replace(/\*\*([^*]+)\*\*/g, '<strong style="color:var(--text)">$1</strong>');
  html = html.replace(/---/g, '<hr style="border:none;border-top:1px solid var(--border);margin:12px 0">');
  return `
    <div style="margin-bottom:8px;display:flex;align-items:center;gap:8px">
      <span style="color:var(--accent);font-size:13px;font-weight:600">JUDICIAL OPINION</span>
      <span class="dispute-tier ${tierName(court) === court ? tierClass(COURT_TIERS.indexOf(court)) : ''}" style="font-size:10px">${court} court</span>
    </div>
    <div class="opinion-text">${html}</div>`;
}

// Verdicts are fetched from the verdict API at /api/verdicts

function escapeHtml(text) {
  return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

async function loadServices() {
  const count = Number(await contract.serviceCount());
  document.getElementById('serviceCountBadge').textContent = count;

  let html = '';
  for (let i = 0; i < count; i++) {
    try {
      const s = await contract.getService(i);
      knownAgents.add(s.provider);
      const statusNames = ['Active', 'Paused', 'Deprecated'];
      html += `
      <div class="service-card">
        <div class="service-info">
          <div class="service-id">Service #${i}</div>
          <div class="service-provider">Provider: ${shortAddr(s.provider)}</div>
          <div class="service-stats-row" style="margin-top:6px">
            <span>Calls: ${Number(s.totalCalls)}</span>
            <span>Disputes: ${Number(s.totalDisputes)}</span>
            <span>Bond: ${formatUSDC(s.bondRequired)} USDC</span>
            <span>Status: ${statusNames[Number(s.status)] || 'Unknown'}</span>
          </div>
        </div>
        <div class="service-price">${formatUSDC(s.price)} USDC</div>
      </div>`;
    } catch(e) {}
  }
  document.getElementById('servicesList').innerHTML = html || '<div style="color:var(--text3);padding:20px;text-align:center">No services registered</div>';
}

async function loadAgents() {
  // Also add judge
  try {
    const judgeAddr = await contract.judge();
    knownAgents.add(judgeAddr);
  } catch(e) {}

  let html = '';
  for (const addr of knownAgents) {
    try {
      const [stats, bal, losses, isReg] = await Promise.all([
        contract.getStats(addr).catch(() => null),
        contract.balances(addr).catch(() => 0n),
        contract.disputeLossCount(addr).catch(() => 0),
        contract.isRegistered(addr).catch(() => false),
      ]);
      if (!isReg && Number(bal) === 0 && (!stats || Number(stats.totalTransactions) === 0)) continue;

      const judgeAddr = await contract.judge();
      const isJudge = addr.toLowerCase() === judgeAddr.toLowerCase();
      const tier = Number(losses) >= 2 ? 2 : Number(losses) >= 1 ? 1 : 0;

      html += `
      <div class="agent-card">
        <div class="agent-header">
          <div>
            <div class="agent-addr">${addr}</div>
            <div style="margin-top:4px">
              <a href="${EXPLORER}/address/${addr}" target="_blank" style="font-size:11px;color:var(--accent);text-decoration:none">View on Explorer &#8599;</a>
            </div>
          </div>
          <div>
            ${isJudge ? '<span class="agent-role role-judge">JUDGE</span>' : '<span class="agent-role role-agent">AGENT</span>'}
            <span class="dispute-tier ${tierClass(tier)}" style="margin-left:6px">${tierName(tier)}</span>
          </div>
        </div>
        <div class="agent-stats">
          <div class="agent-stat">
            <div class="agent-stat-val" style="color:var(--yellow)">${formatUSDC(bal)}</div>
            <div class="agent-stat-label">Court Balance (USDC)</div>
          </div>
          <div class="agent-stat">
            <div class="agent-stat-val">${stats ? Number(stats.totalTransactions) : 0}</div>
            <div class="agent-stat-label">Transactions</div>
          </div>
          <div class="agent-stat">
            <div class="agent-stat-val" style="color:var(--green)">${stats ? Number(stats.disputesWon) : 0}</div>
            <div class="agent-stat-label">Disputes Won</div>
          </div>
          <div class="agent-stat">
            <div class="agent-stat-val" style="color:var(--red)">${stats ? Number(stats.disputesLost) : 0}</div>
            <div class="agent-stat-label">Disputes Lost</div>
          </div>
        </div>
      </div>`;
    } catch(e) { console.error('Agent load error:', addr, e); }
  }
  document.getElementById('agentsList').innerHTML = html || '<div style="color:var(--text3);padding:20px;text-align:center">No registered agents found</div>';
}

// --- TABS ---
function switchTab(name) {
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('panel-' + name).classList.add('active');
}

// --- GO ---
init();
</script>
</body></html>
