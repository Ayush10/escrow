<!DOCTYPE html>
<html><head>
<meta charset="utf-8">
<title>Agent Court — Judge Panel</title>
<script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Berkeley Mono', 'SF Mono', monospace; background: #0a0a0f; color: #c8c8d0; min-height: 100vh; }
.header { padding: 20px 32px; border-bottom: 1px solid #1a1a2e; display: flex; justify-content: space-between; align-items: center; }
.header h1 { font-size: 18px; color: #e0e0e0; }
.header h1 span { color: #e94560; }
.status { display: flex; align-items: center; gap: 10px; font-size: 13px; }
.dot { width: 8px; height: 8px; border-radius: 50%; }
.dot.on { background: #00d4aa; box-shadow: 0 0 6px #00d4aa; }
.dot.off { background: #e94560; }
.connect-btn { padding: 8px 16px; background: #e94560; color: white; border: none; border-radius: 6px; cursor: pointer; font-family: inherit; font-size: 13px; }
.connect-btn:hover { background: #c73652; }
.container { max-width: 900px; margin: 0 auto; padding: 24px; }
.section { margin-bottom: 32px; }
.section h2 { font-size: 15px; color: #888; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; }
.card { background: #12121a; border: 1px solid #1a1a2e; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
.card.active { border-color: #e94560; }
.card .id { font-size: 12px; color: #666; margin-bottom: 8px; }
.card .parties { display: flex; gap: 20px; margin-bottom: 12px; font-size: 13px; }
.card .parties .label { color: #888; }
.card .parties .addr { color: #00d4aa; font-size: 12px; }
.card .stakes { font-size: 14px; margin-bottom: 12px; }
.card .stakes span { color: #f0c040; }
.card .evidence { font-size: 12px; color: #666; margin-bottom: 12px; word-break: break-all; }
.card .actions { display: flex; gap: 8px; }
.card .actions button { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-family: inherit; font-size: 13px; font-weight: bold; }
.btn-plaintiff { background: #1a4d2e; color: #00d4aa; }
.btn-plaintiff:hover { background: #256b3e; }
.btn-defendant { background: #4d1a2e; color: #e94560; }
.btn-defendant:hover { background: #6b2540; }
.resolved { opacity: 0.5; }
.resolved .winner-tag { color: #00d4aa; font-weight: bold; font-size: 13px; }
.stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 32px; }
.stat { background: #12121a; border: 1px solid #1a1a2e; border-radius: 8px; padding: 16px; text-align: center; }
.stat .val { font-size: 24px; color: #e0e0e0; font-weight: bold; }
.stat .lbl { font-size: 12px; color: #666; margin-top: 4px; }
.config { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.config input { width: 100%; padding: 10px; background: #0a0a0f; color: #e0e0e0; border: 1px solid #1a1a2e; border-radius: 6px; font-family: inherit; font-size: 13px; }
.config input:focus { border-color: #e94560; outline: none; }
.config label { font-size: 12px; color: #888; margin-bottom: 4px; display: block; }
.deploy-btn { margin-top: 16px; padding: 12px 24px; background: #e94560; color: white; border: none; border-radius: 6px; cursor: pointer; font-family: inherit; font-size: 14px; font-weight: bold; width: 100%; }
.deploy-btn:hover { background: #c73652; }
.deploy-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.log { background: #0a0a0f; border: 1px solid #1a1a2e; border-radius: 6px; padding: 12px; margin-top: 12px; font-size: 12px; color: #666; max-height: 200px; overflow-y: auto; white-space: pre-wrap; }
.tab-bar { display: flex; gap: 0; margin-bottom: 24px; border-bottom: 1px solid #1a1a2e; }
.tab { padding: 10px 20px; cursor: pointer; font-size: 13px; color: #666; border-bottom: 2px solid transparent; }
.tab.active { color: #e94560; border-bottom-color: #e94560; }
.tab:hover { color: #e0e0e0; }
.panel { display: none; }
.panel.active { display: block; }
.addr-input { width: 100%; padding: 10px; background: #0a0a0f; color: #e0e0e0; border: 1px solid #1a1a2e; border-radius: 6px; font-family: inherit; font-size: 13px; margin-bottom: 12px; }
.addr-input:focus { border-color: #e94560; outline: none; }
</style>
</head><body>

<div class="header">
  <h1><span>Agent Court</span> — Judge Panel</h1>
  <div class="status">
    <div class="dot off" id="dot"></div>
    <span id="statusText">Not connected</span>
    <button class="connect-btn" id="connectBtn" onclick="connectWallet()">Connect Wallet</button>
  </div>
</div>

<div class="container">
  <div class="tab-bar">
    <div class="tab active" onclick="switchTab('disputes')">Disputes</div>
    <div class="tab" onclick="switchTab('deploy')">Deploy</div>
    <div class="tab" onclick="switchTab('interact')">Deposit / Dispute</div>
  </div>

  <!-- DISPUTES PANEL -->
  <div class="panel active" id="panel-disputes">
    <div class="stats">
      <div class="stat"><div class="val" id="totalDisputes">—</div><div class="lbl">Total Disputes</div></div>
      <div class="stat"><div class="val" id="openDisputes">—</div><div class="lbl">Open</div></div>
      <div class="stat"><div class="val" id="contractBalance">—</div><div class="lbl">Contract Balance</div></div>
    </div>
    <div class="section">
      <h2>Open Disputes</h2>
      <div id="openList"><div class="card"><div class="id">Connect wallet and load contract to view disputes</div></div></div>
    </div>
    <div class="section">
      <h2>Resolved</h2>
      <div id="resolvedList"></div>
    </div>
  </div>

  <!-- DEPLOY PANEL -->
  <div class="panel" id="panel-deploy">
    <div class="section">
      <h2>Deploy New Contract</h2>
      <div class="card">
        <div class="config">
          <div><label>Judge Address</label><input id="deployJudge" placeholder="0x... (your address)"></div>
          <div><label>Min Deposit (wei)</label><input id="deployMinDeposit" value="1000000000000000" placeholder="wei"></div>
          <div><label>Judge Fee (wei)</label><input id="deployJudgeFee" value="500000000000000" placeholder="wei"></div>
        </div>
        <button class="deploy-btn" id="deployBtn" onclick="deployContract()">Deploy to GOAT Testnet</button>
        <div class="log" id="deployLog">Ready to deploy...</div>
      </div>
    </div>
    <div class="section">
      <h2>Load Existing Contract</h2>
      <div class="card">
        <input class="addr-input" id="loadAddr" placeholder="Contract address (0x...)">
        <button class="deploy-btn" onclick="loadContract()">Load Contract</button>
      </div>
    </div>
  </div>

  <!-- INTERACT PANEL -->
  <div class="panel" id="panel-interact">
    <div class="section">
      <h2>Deposit</h2>
      <div class="card">
        <div class="config">
          <div><label>Amount (wei)</label><input id="depositAmount" placeholder="wei"></div>
          <div><label>Your Balance</label><input id="yourBalance" readonly value="—"></div>
        </div>
        <button class="deploy-btn" onclick="doDeposit()" style="margin-top:12px">Deposit</button>
      </div>
    </div>
    <div class="section">
      <h2>File Dispute</h2>
      <div class="card">
        <div class="config">
          <div><label>Defendant Address</label><input id="disputeDefendant" placeholder="0x..."></div>
          <div><label>Stake (wei)</label><input id="disputeStake" placeholder="wei"></div>
        </div>
        <label style="font-size:12px;color:#888;margin-top:8px;display:block">Evidence Hash</label>
        <input class="addr-input" id="disputeEvidence" placeholder="0x... (bytes32)" style="margin-top:4px">
        <button class="deploy-btn" onclick="doFileDispute()">File Dispute</button>
      </div>
    </div>
    <div class="log" id="interactLog">Ready...</div>
  </div>
</div>

<script>
const GOAT_TESTNET = { chainId: '0xBEB0', chainName: 'GOAT Testnet3', rpcUrls: ['https://rpc.testnet3.goat.network'], nativeCurrency: { name: 'BTC', symbol: 'BTC', decimals: 18 } };

const ABI = [
  "function deposit() external payable",
  "function withdraw(uint256 amount) external",
  "function commitEvidence(bytes32 txKey, bytes32 evidenceHash) external",
  "function fileDispute(address defendant, uint256 stake, bytes32 plaintiffEvidence) external returns (uint256)",
  "function respondDispute(uint256 disputeId, bytes32 evidence) external",
  "function submitRuling(uint256 disputeId, address winner) external",
  "function getDispute(uint256 disputeId) external view returns (tuple(address plaintiff, address defendant, uint256 plaintiffStake, uint256 defendantStake, bytes32 plaintiffEvidence, bytes32 defendantEvidence, bool resolved, address winner))",
  "function getBalance(address agent) external view returns (uint256)",
  "function isEligible(address agent) external view returns (bool)",
  "function disputeCount() external view returns (uint256)",
  "function judge() external view returns (address)",
  "function balances(address) external view returns (uint256)",
  "event Deposited(address indexed agent, uint256 amount, uint256 newBalance)",
  "event DisputeFiled(uint256 indexed disputeId, address indexed plaintiff, address indexed defendant, uint256 stake)",
  "event RulingSubmitted(uint256 indexed disputeId, address indexed winner, uint256 award)"
];

const BYTECODE = null; // Will be set after compilation
let provider, signer, contract, userAddr;

async function connectWallet() {
  if (!window.ethereum) { alert('Install MetaMask'); return; }
  try {
    await window.ethereum.request({ method: 'eth_requestAccounts' });
    // Switch to GOAT testnet
    try {
      await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: GOAT_TESTNET.chainId }] });
    } catch (e) {
      if (e.code === 4902) {
        await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [GOAT_TESTNET] });
      }
    }
    provider = new ethers.BrowserProvider(window.ethereum);
    signer = await provider.getSigner();
    userAddr = await signer.getAddress();
    document.getElementById('dot').className = 'dot on';
    document.getElementById('statusText').textContent = userAddr.slice(0, 6) + '...' + userAddr.slice(-4);
    document.getElementById('connectBtn').textContent = 'Connected';
    document.getElementById('deployJudge').value = userAddr;
    updateBalance();
  } catch (e) { alert('Connection failed: ' + e.message); }
}

function switchTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('panel-' + name).classList.add('active');
}

async function loadContract() {
  const addr = document.getElementById('loadAddr').value.trim();
  if (!addr || !signer) return;
  contract = new ethers.Contract(addr, ABI, signer);
  await refreshDisputes();
  await updateBalance();
  switchTab('disputes');
  document.querySelector('[onclick="switchTab(\'disputes\')"]').classList.add('active');
}

async function updateBalance() {
  if (!contract || !userAddr) return;
  try {
    const bal = await contract.balances(userAddr);
    document.getElementById('yourBalance').value = ethers.formatEther(bal) + ' BTC';
  } catch(e) {}
}

async function refreshDisputes() {
  if (!contract) return;
  const count = await contract.disputeCount();
  const n = Number(count);
  document.getElementById('totalDisputes').textContent = n;
  let openCount = 0;
  let openHtml = '', resolvedHtml = '';

  for (let i = 0; i < n; i++) {
    const d = await contract.getDispute(i);
    const card = renderDispute(i, d);
    if (d.resolved) {
      resolvedHtml += card;
    } else {
      openCount++;
      openHtml += card;
    }
  }

  document.getElementById('openDisputes').textContent = openCount;
  document.getElementById('openList').innerHTML = openHtml || '<div class="card"><div class="id">No open disputes</div></div>';
  document.getElementById('resolvedList').innerHTML = resolvedHtml || '<div class="card resolved"><div class="id">No resolved disputes yet</div></div>';

  try {
    const bal = await provider.getBalance(await contract.getAddress());
    document.getElementById('contractBalance').textContent = ethers.formatEther(bal) + ' BTC';
  } catch(e) {}
}

function renderDispute(id, d) {
  const short = a => a.slice(0, 8) + '...' + a.slice(-6);
  if (d.resolved) {
    return `<div class="card resolved">
      <div class="id">Dispute #${id}</div>
      <div class="parties">
        <div><span class="label">Plaintiff</span><br><span class="addr">${short(d.plaintiff)}</span></div>
        <div><span class="label">Defendant</span><br><span class="addr">${short(d.defendant)}</span></div>
      </div>
      <div class="winner-tag">Winner: ${short(d.winner)}</div>
    </div>`;
  }
  return `<div class="card active">
    <div class="id">Dispute #${id}</div>
    <div class="parties">
      <div><span class="label">Plaintiff</span><br><span class="addr">${short(d.plaintiff)}</span></div>
      <div><span class="label">Defendant</span><br><span class="addr">${short(d.defendant)}</span></div>
    </div>
    <div class="stakes">Stake: <span>${ethers.formatEther(d.plaintiffStake)} BTC</span> each</div>
    <div class="evidence">P: ${d.plaintiffEvidence}<br>D: ${d.defendantEvidence}</div>
    <div class="actions">
      <button class="btn-plaintiff" onclick="rule(${id}, '${d.plaintiff}')">Rule: Plaintiff Wins</button>
      <button class="btn-defendant" onclick="rule(${id}, '${d.defendant}')">Rule: Defendant Wins</button>
    </div>
  </div>`;
}

async function rule(disputeId, winner) {
  if (!contract) return;
  try {
    const tx = await contract.submitRuling(disputeId, winner);
    await tx.wait();
    alert('Ruling submitted!');
    await refreshDisputes();
  } catch (e) { alert('Ruling failed: ' + e.message); }
}

async function doDeposit() {
  if (!contract) { alert('Load contract first'); return; }
  const amt = document.getElementById('depositAmount').value;
  const log = document.getElementById('interactLog');
  try {
    log.textContent = 'Depositing...';
    const tx = await contract.deposit({ value: amt });
    log.textContent = 'Waiting for confirmation...';
    await tx.wait();
    log.textContent = 'Deposited ' + ethers.formatEther(amt) + ' BTC';
    await updateBalance();
  } catch(e) { log.textContent = 'Error: ' + e.message; }
}

async function doFileDispute() {
  if (!contract) { alert('Load contract first'); return; }
  const def = document.getElementById('disputeDefendant').value;
  const stake = document.getElementById('disputeStake').value;
  const ev = document.getElementById('disputeEvidence').value || ethers.ZeroHash;
  const log = document.getElementById('interactLog');
  try {
    log.textContent = 'Filing dispute...';
    const tx = await contract.fileDispute(def, stake, ev);
    log.textContent = 'Waiting for confirmation...';
    const receipt = await tx.wait();
    log.textContent = 'Dispute filed! TX: ' + receipt.hash;
    await refreshDisputes();
  } catch(e) { log.textContent = 'Error: ' + e.message; }
}

async function deployContract() {
  // Placeholder — needs compiled bytecode
  const log = document.getElementById('deployLog');
  log.textContent = 'Deploy requires compiled bytecode.\nCompile AgentCourt.sol with solc or Hardhat first,\nthen paste bytecode into BYTECODE constant.';
}
</script>
</body></html>
